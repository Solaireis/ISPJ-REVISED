{% extends "base.html" %}
{% block title %}Chat{% endblock %}
{% block head %}
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.3/plyr.css">
    <link rel="stylesheet" href="{{ url_for('static', path='css/chat.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/filepond_grid.css') }}">
    <link href="{{ url_for('filepond_css') }}" rel="stylesheet">
    <link href="{{ url_for('filepond_plugin_image_preview_css') }}" rel="stylesheet"> 
    <script nonce="{{ csp_nonce }}" src="https://cdn.plyr.io/3.7.3/plyr.polyfilled.js"></script>
    <script nonce="{{ csp_nonce }}" async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 
    <script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/password.js') }}"></script>
    <script nonce="{{ csp_nonce }}" type="module" src="https://cdn.jsdelivr.net/npm/@justinribeiro/lite-youtube@1.4.0/lite-youtube.js"></script>
    <script nonce="{{ csp_nonce }}" src="https://www.google.com/recaptcha/enterprise.js?render={{ MIRAI_SITE_KEY }}&onload=onloadCallback&render=explicit"></script>
    <script nonce="{{ csp_nonce }}" type="text/javascript">
        let forgotChatPasswordWidgetId;
        let chatPasswordWidgetId;
        let chatSettingsWidgetId;
        function onloadCallback() {
            chatPasswordWidgetId = grecaptcha.enterprise.render("passwordProtectionSubmit", {
                "sitekey" : "{{ MIRAI_SITE_KEY }}",
                "action" : "enter_chat_password",
                "callback": "passwordCallback",
            });
            chatSettingsWidgetId = grecaptcha.enterprise.render("chatSettingsFormSubmitBtn", {
                "sitekey" : "{{ MIRAI_SITE_KEY }}",
                "action" : "configure_chat_settings",
                "callback" : "chatCallback",
            });
            forgotChatPasswordWidgetId = grecaptcha.enterprise.render("forgotChatPasswordSubmit", {
                "sitekey" : "{{ MIRAI_SITE_KEY }}",
                "action" : "forgot_chat_password",
                "callback" : "forgotChatPassCallback",
            });
        };
    </script>
{% endblock %}
{% from "includes/_show_password_toggle.html" import show_password_toggle %}

{% block content %}
<!-- chat box -->
<div class="h-screen w-full flex antialiased text-gray-800 bg-white overflow-hidden">
    <div class="flex-1 flex flex-col">
        <main class="flex-grow flex flex-row min-h-0">
            <section class="flex flex-col flex-none overflow-auto w-24 lg:max-w-sm md:w-2/5 transition-all duration-300 ease-in-out">
                <div class="header p-4 flex-row justify-between items-center flex-none z-20" style="display: flex;">
                    <div class="w-16 h-16 relative flex flex-shrink-0">
                        <a href="{{ url_for('profile', username=sender.username) }}">
                            <img class="rounded-full w-full h-full object-cover" alt="Your profile picture" src="{{ sender.profile_image }}" referrerpolicy="no-referrer">
                        </a>
                    </div>
                    <a href="/" class="outline outline-2 outline-main-50 first-letter:block p-5 hidden md:block">
                        <img src="{{ url_for('static', path='img/logo.webp') }}" alt="Mirai Logo" class="object-cover h-10 w-30 lg:w-15 lg:h-7">
                    </a>
                </div>
                <div class="search-box px-4 pt-4 flex-none">
                    <div class="relative">
                        <label>
                            <input class="rounded-full py-2 pr-6 pl-10 w-full border border-gray-200 bg-gray-200 focus:bg-white focus:outline-none text-gray-600 focus:shadow-md transition duration-300 ease-in" type="text" value="" placeholder="Search for users" id="userSearchInput">
                            <span class="absolute top-0 left-0 mt-2 ml-3 inline-block">
                                <svg viewBox="0 0 24 24" class="w-6 h-6">
                                    <path fill="#bbb" d="M16.32 14.9l5.39 5.4a1 1 0 0 1-1.42 1.4l-5.38-5.38a8 8 0 1 1 1.41-1.41zM10 16a6 6 0 1 0 0-12 6 6 0 0 0 0 12z"/>
                                </svg>
                            </span>
                        </label>
                        <button class="absolute top-0 right-0 mt-2 mr-3 inline-block hidden" id="resetSearch">
                            <svg viewBox="0 0 24 24" aria-hidden="true" class="w-6 h-6fill-current">
                                <g>
                                    <path fill="#d6204e" d="M10.59 12L4.54 5.96l1.42-1.42L12 10.59l6.04-6.05 1.42 1.42L13.41 12l6.05 6.04-1.42 1.42L12 13.41l-6.04 6.05-1.42-1.42L10.59 12z"></path>
                                </g>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="searchNoResults" class="hidden flex justify-between items-center p-3 relative">
                    <p class="mx-auto">No users found...</p>
                </div>
                <div class="p-2 flex-1 overflow-y-auto" id="chatList"></div>
            </section>

            <!-- Loading screen -->
            <div id="loadingSpinner" class="absolute bg-white bg-opacity-60 z-10 w-full h-full flex items-center justify-center">
                <div class="flex w-full">
                    <img class="mx-auto  max-h-60" src="{{ url_for('static', path='img/chat/bocchi-loading.gif') }}" alt="Bocchi slime loading animated image">
                </div>
            </div>

            <section class="flex flex-col flex-auto border-l">
                <div class="chat-header px-6 py-4 flex flex-row flex-none justify-between items-center shadow">
                    <div class="flex">
                        <div class="w-12 h-12 mr-4 relative flex flex-shrink-0">
                            <a href="{{ url_for('profile', username=receiver.username) }}" id="userProfileLink">
                                <img class="shadow-md rounded-full w-full h-full object-cover"
                                    src="{{ receiver.profile_image }}"
                                    alt="profile picture of the user you're messaging"
                                    referrerpolicy="no-referrer"
                                    id="receiverProfileImage"
                                >
                                <span id="receiverOnlineHeader"></span>
                            </a>
                        </div>
                        <div class="text-md my-auto">
                            <p class="font-bold" id="receiverDisplayName">{{ receiver.display_name }}</p>
                            <p id="receiverUsername">@{{ receiver.username }}</p>
                        </div>
                    </div>

                    <div class="flex">
                        <button type="button" class="block rounded-full hover:bg-gray-200 bg-gray-100 w-10 h-10 p-2 ml-4" data-hs-overlay="#chatSettingModal">
                            <svg class="w-full h-full fill-current text-main-400" viewBox="0 0 20 20">
                                <defs>
                                    <linearGradient id="settings-linear-gradient" gradientTransform="rotate(22.5)">
                                        <stop offset="11.68%" stop-color="#5349da"></stop>
                                        <stop offset="88.32%" stop-color="#b44ac0"></stop>
                                    </linearGradient>
                                </defs>
                                <path d="M10,6.875A3.125,3.125,0,1,0,13.125,10,3.129,3.129,0,0,0,10,6.875Zm0,5A1.875,1.875,0,1,1,11.875,10,1.877,1.877,0,0,1,10,11.875Z"></path>
                                <path d="M19.549,8.849a1.124,1.124,0,0,0-1.116-.974H17.4a.915.915,0,0,1-.828-.608.906.906,0,0,1,.163-1l.722-.723a1.127,1.127,0,0,0,.1-1.495,9.631,9.631,0,0,0-1.608-1.608,1.129,1.129,0,0,0-1.494.1l-.724.724a.92.92,0,0,1-1.018.155.906.906,0,0,1-.588-.82V1.567A1.123,1.123,0,0,0,11.151.451a8.782,8.782,0,0,0-2.3,0,1.123,1.123,0,0,0-.974,1.116V2.6a.915.915,0,0,1-.608.828.907.907,0,0,1-1-.163l-.723-.722a1.126,1.126,0,0,0-1.495-.1A9.631,9.631,0,0,0,2.443,4.051a1.127,1.127,0,0,0,.1,1.494l.724.724a.917.917,0,0,1,.155,1.018.906.906,0,0,1-.82.588H1.567a1.123,1.123,0,0,0-1.116.974,8.754,8.754,0,0,0,0,2.3,1.123,1.123,0,0,0,1.116.974H2.6a.915.915,0,0,1,.828.608.906.906,0,0,1-.163,1l-.722.723a1.127,1.127,0,0,0-.1,1.495,9.707,9.707,0,0,0,1.608,1.608,1.13,1.13,0,0,0,1.494-.1l.724-.724a.916.916,0,0,1,1.018-.155.906.906,0,0,1,.588.82v1.031a1.123,1.123,0,0,0,.974,1.116,8.754,8.754,0,0,0,2.3,0,1.123,1.123,0,0,0,.974-1.116V17.4a.915.915,0,0,1,.608-.828.906.906,0,0,1,1,.163l.724.724a1.132,1.132,0,0,0,1.494.1,9.707,9.707,0,0,0,1.608-1.608,1.127,1.127,0,0,0-.1-1.494l-.724-.724a.917.917,0,0,1-.155-1.018.906.906,0,0,1,.82-.588h1.031a1.123,1.123,0,0,0,1.116-.974,8.754,8.754,0,0,0,0-2.3Zm-1.226,2.026H17.4a2.224,2.224,0,0,0-1.549,3.741l.65.65A8.459,8.459,0,0,1,15.266,16.5l-.65-.65A2.224,2.224,0,0,0,10.875,17.4v.921a7.216,7.216,0,0,1-1.75,0V17.4A2.159,2.159,0,0,0,7.747,15.42a2.154,2.154,0,0,0-2.363.433l-.65.65A8.459,8.459,0,0,1,3.5,15.266l.65-.65A2.224,2.224,0,0,0,2.6,10.875H1.677a7.388,7.388,0,0,1,0-1.75H2.6A2.159,2.159,0,0,0,4.58,7.747a2.152,2.152,0,0,0-.433-2.363l-.65-.65A8.362,8.362,0,0,1,4.734,3.5l.65.65a2.162,2.162,0,0,0,2.382.425A2.15,2.15,0,0,0,9.125,2.6V1.677a7.216,7.216,0,0,1,1.75,0V2.6A2.159,2.159,0,0,0,12.253,4.58a2.158,2.158,0,0,0,2.363-.433l.65-.65A8.362,8.362,0,0,1,16.5,4.734l-.65.65a2.16,2.16,0,0,0-.425,2.382A2.15,2.15,0,0,0,17.4,9.125h.921a7.388,7.388,0,0,1,0,1.75Z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="chat-body p-4 flex-1 overflow-y-scroll relative overflow-x-hidden" id="mainMsgDiv">
                    <!-- Loading old message alert -->
                    <div class="pb-4 flex justify-center items-center space-x-2 hidden" id="loadingOldMsgAlert">
                        <p class="animate-bounce text-gray-500">Loading old messages...</p>
                    </div>
                    <div id="chatArea"></div>
                </div> 
                <div class="chat-footer flex-none">
                    <div class="flex flex-row items-center p-4">
                        <!-- Images -->
                        <button type="button" data-hs-overlay="#fileModal" class="flex flex-shrink-0 focus:outline-none mx-2 block text-main-100 hover:text-main-900 w-6 h-6" id="fileModalBtn">
                            <svg viewBox="0 0 20 20" class="w-full h-full fill-current">
                                <path d="M10,1.6c-4.639,0-8.4,3.761-8.4,8.4s3.761,8.4,8.4,8.4s8.4-3.761,8.4-8.4S14.639,1.6,10,1.6z M15,11h-4v4H9  v-4H5V9h4V5h2v4h4V11z"/>
                            </svg>
                        </button>
                        <div class="relative flex-grow">
                            <label>
                                <textarea id="messageText" class="resize-none block py-2 pl-3 pr-10 w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="" spellcheck="true" autofocus maxlength="{{ max_msg_len }}"></textarea>
                                <button type="button" id="emojiBtn" class="absolute top-0 right-0 mt-2 mr-3 flex flex-shrink-0 focus:outline-none block text-main-100 hover:text-main-900 w-6 h-6">
                                    <svg viewBox="0 0 20 20" class="w-full h-full fill-current">
                                        <path d="M10 20a10 10 0 1 1 0-20 10 10 0 0 1 0 20zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM6.5 9a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm7 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm2.16 3a6 6 0 0 1-11.32 0h11.32z" />
                                    </svg>
                                </button>
                            </label>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<div id="chatPasswordModal" class="hs-overlay hidden w-full h-full fixed top-0 left-0 z-[60] overflow-x-hidden overflow-y-auto [--overlay-backdrop:static]" data-hs-overlay-keyboard="false">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto">
        <div class="flex flex-col bg-white border shadow-sm rounded-xl   /[.7]">
            <div class="flex justify-between items-center py-3 px-4 border-b ">
                <h3 class="font-bold text-gray-800 ">
                    Chat Password Protection Enabled
                </h3>
                <a href="/" class="hs-dropdown-toggle inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-white transition-all text-sm  ">
                <span class="sr-only">Close</span>
                <svg class="w-3.5 h-3.5" width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.258206 1.00652C0.351976 0.912791 0.479126 0.860131 0.611706 0.860131C0.744296 0.860131 0.871447 0.912791 0.965207 1.00652L3.61171 3.65302L6.25822 1.00652C6.30432 0.958771 6.35952 0.920671 6.42052 0.894471C6.48152 0.868271 6.54712 0.854471 6.61352 0.853901C6.67992 0.853321 6.74572 0.865971 6.80722 0.891111C6.86862 0.916251 6.92442 0.953381 6.97142 1.00032C7.01832 1.04727 7.05552 1.1031 7.08062 1.16454C7.10572 1.22599 7.11842 1.29183 7.11782 1.35822C7.11722 1.42461 7.10342 1.49022 7.07722 1.55122C7.05102 1.61222 7.01292 1.6674 6.96522 1.71352L4.31871 4.36002L6.96522 7.00648C7.05632 7.10078 7.10672 7.22708 7.10552 7.35818C7.10442 7.48928 7.05182 7.61468 6.95912 7.70738C6.86642 7.80018 6.74102 7.85268 6.60992 7.85388C6.47882 7.85498 6.35252 7.80458 6.25822 7.71348L3.61171 5.06702L0.965207 7.71348C0.870907 7.80458 0.744606 7.85498 0.613506 7.85388C0.482406 7.85268 0.357007 7.80018 0.264297 7.70738C0.171597 7.61468 0.119017 7.48928 0.117877 7.35818C0.116737 7.22708 0.167126 7.10078 0.258206 7.00648L2.90471 4.36002L0.258206 1.71352C0.164476 1.61976 0.111816 1.4926 0.111816 1.36002C0.111816 1.22744 0.164476 1.10028 0.258206 1.00652Z" fill="currentColor"/>
                </svg>
                </a>
            </div>
            
            <div class="p-4 overflow-y-auto">
                <div id="chatPasswordError" class="hidden flex p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    <svg aria-hidden="true" class="flex-shrink-0 inline w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    <span class="sr-only">Info</span>
                    <div id="chatPasswordErrorMsg"></div>
                </div>
                <div id="chatPasswordSuccess" class="hidden flex p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                    <svg aria-hidden="true" class="flex-shrink-0 inline w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    <span class="sr-only">Info</span>
                    <div id="chatPasswordSuccessMsg"></div>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-black text-md">You currently have chat password protection enabled.</span>
                    </label>
                    <form id="passwordProtectionForm">
                        <div class="relative">
                            <input type="password" id="chatPasswordInput" name="chatPasswordInput" placeholder="Enter your chat password" class="input input-bordered w-full border border-gray-700 bg-white" required>
                            {{ show_password_toggle(csp_nonce, "chatPasswordInput", None, "chatPassInpToggleBtn", "chatPassInpShowSvg", "chatPassInpHideSvg") }}
                        </div>
                        <div class="flex justify-between pt-2">
                            <div class="flex items-start">
                                <label class="inline-flex relative items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" name="doNotAskAgain">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  rounded-full peer  peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-main-100"></div>
                                    <span class="ml-3 label-text-alt">
                                        Do not ask me again
                                    </span>
                                </label>
                            </div>
                        </div>
                    </form>
                    <div class="label-text-alt flex items-center mt-2">
                        If you've forgotten your chat password, please click <button id="forgotChatPasswordSubmit" class="text-main-100 font-bold italic hover:underline hover:text-main-900 ml-1">here</button>.
                    </div>
                </div>
                <p class="mt-1 label-text text-black">
                    This site is protected by reCAPTCHA Enterprise and the Google
                    <a href="https://policies.google.com/privacy" class="text-main-100 font-bold italic hover:underline">Privacy Policy</a> and
                    <a href="https://policies.google.com/terms" class="text-main-100 font-bold italic hover:underline hover:text-main-900">Terms of Service</a> apply.
                </p>
            </div>
            <div class="flex justify-end items-center gap-x-2 py-3 px-4 border-t ">
                <a href="/" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border font-medium bg-white text-gray-700 shadow-sm align-middle hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-main-900 transition-all text-sm">
                    Back to Home
                </a>
                <button type="button" id="passwordProtectionSubmit" class="py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border border-transparent font-semibold btn-main text-sm ">
                    Submit
                </button>
            </div>
        </div>
    </div>
</div>

<div id="chatSettingModal" class="hs-overlay hidden w-full h-full fixed top-0 left-0 z-[60] overflow-x-hidden overflow-y-auto [--overlay-backdrop:static]">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto">
        <div class="flex flex-col bg-white border shadow-sm rounded-xl /[.7]">
            <div class="flex justify-between items-center py-3 px-4 border-b ">
                <h3 class="font-bold text-gray-800 ">
                    Chat Settings
                </h3>
                <button type="button" class="hs-dropdown-toggle inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-white transition-all text-sm  " data-hs-overlay="#chatSettingModal">
                <span class="sr-only">Close</span>
                <svg class="w-3.5 h-3.5" width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.258206 1.00652C0.351976 0.912791 0.479126 0.860131 0.611706 0.860131C0.744296 0.860131 0.871447 0.912791 0.965207 1.00652L3.61171 3.65302L6.25822 1.00652C6.30432 0.958771 6.35952 0.920671 6.42052 0.894471C6.48152 0.868271 6.54712 0.854471 6.61352 0.853901C6.67992 0.853321 6.74572 0.865971 6.80722 0.891111C6.86862 0.916251 6.92442 0.953381 6.97142 1.00032C7.01832 1.04727 7.05552 1.1031 7.08062 1.16454C7.10572 1.22599 7.11842 1.29183 7.11782 1.35822C7.11722 1.42461 7.10342 1.49022 7.07722 1.55122C7.05102 1.61222 7.01292 1.6674 6.96522 1.71352L4.31871 4.36002L6.96522 7.00648C7.05632 7.10078 7.10672 7.22708 7.10552 7.35818C7.10442 7.48928 7.05182 7.61468 6.95912 7.70738C6.86642 7.80018 6.74102 7.85268 6.60992 7.85388C6.47882 7.85498 6.35252 7.80458 6.25822 7.71348L3.61171 5.06702L0.965207 7.71348C0.870907 7.80458 0.744606 7.85498 0.613506 7.85388C0.482406 7.85268 0.357007 7.80018 0.264297 7.70738C0.171597 7.61468 0.119017 7.48928 0.117877 7.35818C0.116737 7.22708 0.167126 7.10078 0.258206 7.00648L2.90471 4.36002L0.258206 1.71352C0.164476 1.61976 0.111816 1.4926 0.111816 1.36002C0.111816 1.22744 0.164476 1.10028 0.258206 1.00652Z" fill="currentColor"/>
                </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto" id="chatSettings">
                <div class="space-y-4">
                    <div class="hs-accordion-group">
                        <div id="chatSettingError" class="hidden flex p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                            <svg aria-hidden="true" class="flex-shrink-0 inline w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <span class="sr-only">Info</span>
                            <div id="chatSettingErrorMsg"></div>
                        </div>
                        <div id="chatSettingSuccess" class="hidden flex p-4 mb-4 text-sm text-green-700 bg-green-100 rounded-lg" role="alert">
                            <svg aria-hidden="true" class="flex-shrink-0 inline w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                            <span class="sr-only">Info</span>
                            <div id="chatSettingSuccessMsg"></div>
                        </div>

                        <div class="hs-accordion bg-white border -mt-px first:rounded-t-lg last:rounded-b-lg  " id="contentModerationAccordion">
                            <button class="hs-accordion-toggle hs-accordion-active:text-main-900 inline-flex items-center gap-x-3 w-full font-semibold text-left text-main-100 transition py-4 px-5 hover:text-main-500 " aria-controls="contentModerationAccordion">
                                <svg class="hs-accordion-active:hidden hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-blue-600 block w-3 h-3 text-main-100 group-hover:text-main-500 " width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                    <path d="M8 15.36L8 2.35999" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg>
                                <svg class="hs-accordion-active:block hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-main-900 hidden w-3 h-3 text-main-100 group-hover:text-main-100" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg> Image Content Moderation
                            </button>
                            <div id="contentModerationAccordion" class="hs-accordion-content hidden w-full overflow-hidden transition-[height] duration-300" aria-labelledby="contentModerationAccordion">
                                <div class="pb-4 px-5">
                                    <div class="my-2 flex flex-col justify-start">
                                        <label class="inline-flex relative items-center cursor-pointer">
                                            <input type="checkbox" value="" class="sr-only peer" name="blursexualImages">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  rounded-full peer  peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-main-100"></div>
                                            <span class="ml-3 text-md text-gray-900 font-bold">
                                                Blur sexual images
                                            </span>
                                        </label>
                                    </div>
                                    <div class="my-2 flex flex-col justify-start">
                                        <label class="inline-flex relative items-center cursor-pointer">
                                            <input type="checkbox" value="" class="sr-only peer" name="blurViolentImages">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  rounded-full peer  peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-main-100"></div>
                                            <span class="ml-3 text-md text-gray-900 font-bold">
                                                Blur violent images
                                            </span>
                                        </label>
                                    </div>
                                    <div class="my-2 flex flex-col justify-start">
                                        <label class="inline-flex relative items-center cursor-pointer">
                                            <input type="checkbox" value="" class="sr-only peer" name="blurMemeImages">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  rounded-full peer  peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-main-100"></div>
                                            <span class="ml-3 text-md text-gray-900 font-bold">
                                                Blur meme images
                                            </span>
                                        </label>
                                    </div>
                                    <span class="label-text-alt pt-2 col-span-2">
                                        Note: This setting will affect your home feed.
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="hs-accordion bg-white border -mt-px first:rounded-t-lg last:rounded-b-lg  " id="privacyAccordionHeading">
                            <button class="hs-accordion-toggle hs-accordion-active:text-main-900 inline-flex items-center gap-x-3 w-full font-semibold text-left text-main-100 transition py-4 px-5 hover:text-main-500 " aria-controls="privacyAccordion">
                                <svg class="hs-accordion-active:hidden hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-blue-600 block w-3 h-3 text-main-100 group-hover:text-main-500 " width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                    <path d="M8 15.36L8 2.35999" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg>
                                <svg class="hs-accordion-active:block hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-main-900 hidden w-3 h-3 text-main-100 group-hover:text-main-100" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg> Privacy Settings 
                            </button>
                            <div id="privacyAccordion" class="hs-accordion-content hidden w-full overflow-hidden transition-[height] duration-300" aria-labelledby="privacyAccordionHeading">
                                <div class="pb-4 px-5">
                                    <div class="my-2 flex flex-col justify-start">
                                        <label class="inline-flex relative items-center cursor-pointer">
                                            <input type="checkbox" value="" class="sr-only peer" name="hideOnlineStatus">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300  rounded-full peer  peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-main-100"></div>
                                            <span class="ml-3 text-md text-gray-900 font-bold">
                                                Hide Online Status
                                            </span>
                                        </label>
                                        <span class="label-text-alt pt-2">
                                            Note: This will hide your online status from other users in the chat.
                                        </span>
                                    </div>
                                    <div class="form-control w-full">
                                        <label class="label">
                                            <span class="label-text text-black text-md font-bold">Configure Your Disappearing Message Timer</span>
                                        </label>
                                        <select name="messageTimer" class="select select-bordered bg-white text-gray-500">
                                            <option value="disabled">Disabled</option>
                                            <option value="1h">1 Hour</option>
                                            <option value="24h">24 Hours</option>
                                            <option value="7d">7 Days</option>
                                            <option value="1m">1 Month</option>
                                            <option value="6m">6 Months</option>
                                            <option value="1y">1 Year</option>
                                        </select>
                                        <label class="label">
                                            <span class="label-text-alt">
                                                Note: This will only affect new messages for both parties.
                                                <br>
                                                Messages with a self-destructing timer are indicated by the chat bubbles with a darker shade of colour.
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hs-accordion bg-white border -mt-px first:rounded-t-lg last:rounded-b-lg  " id="chatPasswordAccordionHeading">
                            <button class="hs-accordion-toggle hs-accordion-active:text-main-900 inline-flex items-center gap-x-3 w-full font-semibold text-left text-main-100 transition py-4 px-5 hover:text-main-500 " aria-controls="chatPasswordAccordion">
                                <svg class="hs-accordion-active:hidden hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-blue-600 block w-3 h-3 text-main-100 group-hover:text-main-500 " width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                    <path d="M8 15.36L8 2.35999" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg>
                                <svg class="hs-accordion-active:block hs-accordion-active:text-main-900 hs-accordion-active:group-hover:text-main-900 hidden w-3 h-3 text-main-100 group-hover:text-main-100" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 8.85999L14.5 8.85998" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                </svg> Chat Password 
                            </button>
                            <div id="chatPasswordAccordion" class="hs-accordion-content hidden w-full overflow-hidden transition-[height] duration-300" aria-labelledby="chatPasswordAccordionHeading">
                                <div class="pb-4 px-5">
                                    <form id="chatSettingsForm">
                                        {% if sender.has_password_protection %}
                                            <div class="space-y-4 mt-2">
                                                <div class="form-control w-full">
                                                    <label class="label">
                                                        <span class="label-text text-black text-md font-bold">Remove Password Protection To All Chats</span>
                                                    </label>
                                                    <div class="relative">
                                                        <input type="password" id="passwordInput" name="passwordInput" placeholder="Enter your current chat password to remove" class="input input-bordered w-full border border-gray-700 bg-white" minlength="6" maxlength="64">
                                                        {{ show_password_toggle(csp_nonce, "passwordInput") }}
                                                    </div>
                                                    <label class="label">
                                                        <span class="label-text-alt">Tip: To change your chat password, you can simply remove and add again.</span>
                                                    </label>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="space-y-4 mt-2">
                                                <div class="form-control w-full">
                                                    <label class="label">
                                                        <span class="label-text text-black text-md font-bold">Add Password Protection To All Chats</span>
                                                    </label>
                                                    <div class="relative">
                                                        <input type="password" id="passwordInput" name="passwordInput" placeholder="Enter a password for chat protection" class="input input-bordered w-full border border-gray-700 bg-white" minlength="6" maxlength="64">
                                                    </div>
                                                </div>
                                                <div class="form-control w-full">
                                                    <input type="password" id="confirmPasswordInput" name="confirmPasswordInput" placeholder="Confirm password" class="input input-bordered w-full border border-gray-700 bg-white" minlength="6" maxlength="64">
                                                    <label class="label">
                                                        <span class="label-text-alt">Note: You will be asked for a password next time when entering any chat session.</span>
                                                    </label>
                                                </div>
                                            </div>
                                        {% endif %}
                                        <div class="flex">
                                            <button type="button" id="chatSettingsFormSubmitBtn" class="py-3 px-4 gap-2 rounded-md border border-transparent font-semibold btn-main text-sm ml-auto">
                                                Save changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="my-1 label-text text-black">
                    This site is protected by reCAPTCHA Enterprise and the Google
                    <a href="https://policies.google.com/privacy" class="text-main-100 font-bold italic hover:underline">Privacy Policy</a> and
                    <a href="https://policies.google.com/terms" class="text-main-100 font-bold italic hover:underline hover:text-main-900">Terms of Service</a> apply.
                </p>
            </div>
            <div class="flex justify-end items-center gap-x-2 py-3 px-4 border-t ">
                <button type="button" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border font-medium bg-white text-gray-700 shadow-sm align-middle hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-white focus:ring-main-900 transition-all text-sm" data-hs-overlay="#chatSettingModal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<div id="fileModal" class="hs-overlay hidden w-full h-full fixed top-0 left-0 z-[60] overflow-x-hidden overflow-y-auto [--overlay-backdrop:static]">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto h-[calc(100%-3.5rem)]">
        <div class="max-h-full overflow-hidden flex flex-col bg-white border shadow-sm rounded-xl   /[.7]">
            <div class="flex justify-between items-center py-3 px-4 border-b ">
                <h3 class="font-bold text-gray-800 ">
                    Send File Messages
                </h3>
                <button type="button" class="hs-dropdown-toggle inline-flex flex-shrink-0 justify-center items-center h-8 w-8 rounded-md text-gray-500 hover:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 focus:ring-offset-white transition-all text-sm  " data-hs-overlay="#fileModal">
                <span class="sr-only">Close</span>
                <svg class="w-3.5 h-3.5" width="8" height="8" viewBox="0 0 8 8" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.258206 1.00652C0.351976 0.912791 0.479126 0.860131 0.611706 0.860131C0.744296 0.860131 0.871447 0.912791 0.965207 1.00652L3.61171 3.65302L6.25822 1.00652C6.30432 0.958771 6.35952 0.920671 6.42052 0.894471C6.48152 0.868271 6.54712 0.854471 6.61352 0.853901C6.67992 0.853321 6.74572 0.865971 6.80722 0.891111C6.86862 0.916251 6.92442 0.953381 6.97142 1.00032C7.01832 1.04727 7.05552 1.1031 7.08062 1.16454C7.10572 1.22599 7.11842 1.29183 7.11782 1.35822C7.11722 1.42461 7.10342 1.49022 7.07722 1.55122C7.05102 1.61222 7.01292 1.6674 6.96522 1.71352L4.31871 4.36002L6.96522 7.00648C7.05632 7.10078 7.10672 7.22708 7.10552 7.35818C7.10442 7.48928 7.05182 7.61468 6.95912 7.70738C6.86642 7.80018 6.74102 7.85268 6.60992 7.85388C6.47882 7.85498 6.35252 7.80458 6.25822 7.71348L3.61171 5.06702L0.965207 7.71348C0.870907 7.80458 0.744606 7.85498 0.613506 7.85388C0.482406 7.85268 0.357007 7.80018 0.264297 7.70738C0.171597 7.61468 0.119017 7.48928 0.117877 7.35818C0.116737 7.22708 0.167126 7.10078 0.258206 7.00648L2.90471 4.36002L0.258206 1.71352C0.164476 1.61976 0.111816 1.4926 0.111816 1.36002C0.111816 1.22744 0.164476 1.10028 0.258206 1.00652Z" fill="currentColor"/>
                </svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <input id="filepondInput" type="file" class="filepond" name="file">
                    </div>
                    <div class="w-full px-2 pt-2">
                        <textarea id="chatMsgFileTextInput" class="text-gray-900 placeholder-gray-400 w-full h-10 bg-transparent rounded-lg border border-gray-300 focus:outline-none resize-none" placeholder="" maxlength="{{ max_msg_len }}" spellcheck="true" style="height: 65px"></textarea>
                    </div>
                    <div class="w-full text-right" style="margin-top: 0px">
                        <button type="button" id="emojiBtnFileModal" class=" text-main-500 hover:bg-pink-100 rounded-full p-2">
                            <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor">
                                <g>
                                    <path d="M12 22.75C6.072 22.75 1.25 17.928 1.25 12S6.072 1.25 12 1.25 22.75 6.072 22.75 12 17.928 22.75 12 22.75zm0-20C6.9 2.75 2.75 6.9 2.75 12S6.9 21.25 12 21.25s9.25-4.15 9.25-9.25S17.1 2.75 12 2.75z"></path>
                                    <path d="M12 17.115c-1.892 0-3.633-.95-4.656-2.544-.224-.348-.123-.81.226-1.035.348-.226.812-.124 1.036.226.747 1.162 2.016 1.855 3.395 1.855s2.648-.693 3.396-1.854c.224-.35.688-.45 1.036-.225.35.224.45.688.226 1.036-1.025 1.594-2.766 2.545-4.658 2.545z"></path>
                                    <circle cx="14.738" cy="9.458" r="1.478"></circle>
                                    <circle cx="9.262" cy="9.458" r="1.478"></circle>
                                </g>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end items-center gap-x-2 py-3 px-4 border-t ">
                <button type="button" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border font-medium shadow-sm align-middle bg-red-500 hover:bg-red-700 text-white" id="fileClearBtn">
                    Clear Files
                </button>
                <button type="button" class="hs-dropdown-toggle py-3 px-4 inline-flex justify-center items-center gap-2 rounded-md border font-medium shadow-sm align-middle btn-main" id="fileUploadBtn">
                    Send Message
                </button>
            </div>
        </div>
    </div>
</div>

{% include "includes/_image_view.html" %}

<div id="deleteMsgModal" class="hidden fixed top-0 left-0 z-999 w-screen h-screen bg-black/70 flex justify-center items-center z-20">
    <div class="p-4 w-full max-w-md h-full md:h-auto">
        <div class="bg-white rounded-lg shadow ">
            <div class="flex justify-end p-2">
                <button type="button" class="text-gray-600 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center  closeDeleteMsgModal">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>  
                </button>
            </div>
            <div class="p-6 pt-0 text-center">
                <svg class="mx-auto mb-4 w-14 h-14 text-gray-500 " fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mb-5 text-lg font-normal text-gray-500 ">
                    Are you sure you want to delete this message?
                </h3>
                <button id="deleteMsgButton" type="button" class="text-white bg-gradient-to-br from-red-400 to-red-600 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 text-center inline-flex items-center shadow-md shadow-gray-300 hover:scale-[1.02] transition-transform">
                    Yes, I'm sure
                </button>
                <button type="button" class="text-gray-600 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 closeDeleteMsgModal">
                    No, cancel
                </button>
            </div>
        </div>
    </div>
</div>

{% if sender.has_password_protection == False %}
    {{ show_password_toggle(csp_nonce, "passwordInput", "confirmPasswordInput") }}
{% endif %}

<script nonce="{{ csp_nonce }}" src="https://cdnjs.cloudflare.com/ajax/libs/crc-32/1.2.2/crc32c.min.js"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('filepond_plugin_image_preview_js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('filepond_plugin_image_exif_orientation_js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('filepond_plugin_file_validate_size_js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('filepond_js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/time.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/msg_and_image.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/embeds.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/bundles.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/chat.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/textarea.js') }}"></script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', path='js/upload_file.js') }}"></script>
<script nonce="{{ csp_nonce }}">
    let insufficientPerms = false; // Depends on the user's privacy settings
    let blocked = false; // Prevents the user from sending messages when blocked
    let lastMsg = "";
    const chatMsgFileTextInput = document.getElementById("chatMsgFileTextInput");

    textareaAutoAdjust(inputMsg, 180);
    textareaAutoAdjust(chatMsgFileTextInput, 180);

    const emojiBtn = document.getElementById("emojiBtn");
    const picker = createPopup({
    }, {
        referenceElement: emojiBtn,
        triggerElement: emojiBtn,
        position: "top-end",
    });
    emojiBtn.addEventListener("click", () => {
        picker.toggle();
    });
    picker.addEventListener("emoji:select", (event) => {
        if (blocked || insufficientPerms) {
            return;
        }
        inputMsg.value += event.emoji;
        chatMsgFileTextInput.value += event.emoji;
    });

    textareaAutoAdjust(chatMsgFileTextInput, 250);
    inputMsg.addEventListener("input", () => {
        chatMsgFileTextInput.value = inputMsg.value;
    });
    chatMsgFileTextInput.addEventListener("input", () => {
        inputMsg.value = chatMsgFileTextInput.value;
    });

    const emojiBtnFileModal = document.getElementById("emojiBtnFileModal");
    const pickerFileModal = createPopup({
    }, {
        referenceElement: emojiBtnFileModal,
        triggerElement: emojiBtnFileModal,
        position: "bottom-end",
        className: "z-[999]",
    });
    emojiBtnFileModal.addEventListener("click", () => {
        pickerFileModal.toggle();
    });
    pickerFileModal.addEventListener("emoji:select", (event) => {
        if (blocked || insufficientPerms) {
            return;
        }
        inputMsg.value += event.emoji;
        chatMsgFileTextInput.value += event.emoji;
    });

    const textAreas = [chatMsgFileTextInput, inputMsg];
    const formatTextareaInputLogic = (clearErr, msg) => {
        warningClassLists = [
            "cursor-not-allowed",
            "border-red-500",
        ]
        defaultClassLists = [
            "border-gray-300",
        ]
        for (const textArea of textAreas) {
            textArea.value = "";
            textArea.placeholder = clearErr ? 
                inputMsgPlaceholder : msg;

            textArea.disabled = !clearErr;
            for (const classList of warningClassLists) {
                clearErr ? 
                    textArea.classList.remove(classList) : textArea.classList.add(classList);
            }
            for (const classList of defaultClassLists) {
                clearErr ? 
                    textArea.classList.add(classList) : textArea.classList.remove(classList);
            }
        }
    };
</script>
<script nonce="{{ csp_nonce }}">
    const chatSettings = document.getElementById("chatSettings");
    const chatSettingsForm = document.getElementById("chatSettingsForm");
    const chatSettingsSubmitBtn = document.getElementById("chatSettingsFormSubmitBtn");
    const hideOnlineStatus = chatSettings.querySelector("[name='hideOnlineStatus']");
    const chatSettingsMsgTimer = chatSettings.querySelector("[name='messageTimer']");
    const chatSettingPassword = chatSettings.querySelector("[name='passwordInput']");
    const chatSettingPasswordConfirm = chatSettings.querySelector("[name='confirmPasswordInput']");

    // Success and error messages
    const chatSettingSuccess = document.getElementById("chatSettingSuccess");
    const chatSettingSuccessMsg = document.getElementById("chatSettingSuccessMsg");
    const chatSettingError = document.getElementById("chatSettingError");
    const chatSettingErrorMsg = document.getElementById("chatSettingErrorMsg");
    document.getElementById("chatSettingModal").addEventListener("close.hs.overlay", () => {
        chatSettingSuccess.classList.add("hidden");
        chatSettingSuccessMsg.innerText = "";
        chatSettingError.classList.add("hidden");
        chatSettingErrorMsg.innerText = "";
    })

    const contentModerationUrl = "{{ url_for('update_content_moderation_settings') }}";
    const chatSettingUrl = "{{ url_for('chat_update_settings') }}";
    function processChatSettingsResponse(url, data) {
        chatSettingSuccessMsg.innerText = data.message;
        chatSettingSuccess.classList.remove("hidden");
        chatSettingError.classList.add("hidden");
        if (url !== chatSettingUrl && url !== contentModerationUrl) {
            // Reload the page after 1 second 
            // after adding/removing chat password
            setInterval(() => {
                location.reload();
            }, 1000);
        }
    }
    function chatSettingsFetch (url, data) {
        fetch(url, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "{{ CSRF_HEADER_NAME }}": getCSRFToken(),
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            const data = response.json();
            if (response.ok) {
                return data;
            } else if (response.status == 429) {
                throw new Error("Please fill out all the fields correctly.");
            } else {
                throw new Error(data.message || "Something went wrong");
            }
        })
        .then(data => {
            processChatSettingsResponse(url, data);
        })
        .catch(error => {
            console.error(error);
            chatSettingErrorMsg.innerText = error;
            chatSettingError.classList.remove("hidden");
            chatSettingSuccess.classList.add("hidden");
        });
    }

    hideOnlineStatus.addEventListener("change", (e) => {
        chatSettingsFetch(
            chatSettingUrl,
            {hide_online_status: e.target.checked},
        )
    });
    chatSettingsMsgTimer.addEventListener("change", (e) => {
        chatSettingsFetch(
            chatSettingUrl,
            {message_timer: e.target.value},
        );
    });

    let blursexualImages = {{ sender.blur_sexual_images | lower }};
    let blurViolentImages = {{ sender.blur_violent_images | lower }};
    let blurMemeImages = {{ sender.blur_meme_images | lower }};
    const blursexualImagesEl = document.querySelector("[name='blursexualImages']");
    const blurViolentImagesEl = document.querySelector("[name='blurViolentImages']");
    const blurMemeImagesEl = document.querySelector("[name='blurMemeImages']");
    for (const el of [blursexualImagesEl, blurViolentImagesEl, blurMemeImagesEl]) {
        el.addEventListener("change", (e) => {
            blursexualImages = blursexualImagesEl.checked;
            blurViolentImages = blurViolentImagesEl.checked;
            blurMemeImages = blurMemeImagesEl.checked;
            chatSettingsFetch(
                contentModerationUrl,
                {
                    sexual_images: blursexualImages,
                    violent_images: blurViolentImages,
                    meme_images: blurMemeImages,
                },
            );
        });
    }

    // update the settings to the user's current settings
    const messageIntToStringMap = {{ MESSAGE_TIMER_INT_TO_STR | safe }};
    chatSettingsMsgTimer.value = messageIntToStringMap["{{ sender.message_timer }}"];
    hideOnlineStatus.checked = {{ sender.hide_online_status | lower }};
    blursexualImagesEl.checked = {{ sender.blur_sexual_images | lower }};
    blurViolentImagesEl.checked = {{ sender.blur_violent_images | lower }};
    blurMemeImagesEl.checked = {{ sender.blur_meme_images | lower }};

    chatSettingsForm.addEventListener("submit", (e) => {
        e.preventDefault();
        grecaptcha.enterprise.execute(chatSettingsWidgetId);
    });
    function chatCallback(token) {
        if (chatSettingPasswordConfirm !== null && chatSettingPassword.value != chatSettingPasswordConfirm.value) {
            chatSettingErrorMsg.innerText = "Passwords do not match.";
            chatSettingError.classList.remove("hidden");
            chatSettingSuccess.classList.add("hidden");
            grecaptcha.enterprise.reset(chatSettingsWidgetId);
            return;
        }

        let passwordInput = chatSettingPassword.value;
        if (passwordInput === "") {
            return;
        }

        const data = {
            password: passwordInput,
            recaptcha_token: token,
        };
        chatSettingsFetch(
            "{{ url_for('chat_update_password') }}",
            data,
        );

        grecaptcha.enterprise.reset(chatSettingsWidgetId);
    };
</script>
<script nonce="{{ csp_nonce }}">
    FilePond.registerPlugin(
        FilePondPluginImagePreview,
        FilePondPluginImageExifOrientation,
        FilePondPluginFileValidateSize,
    );
    let isUploading = false;
    let uploadToken = null;
    const resetFileModalBtns = () => {
        uploadToken = null;
        isUploading = false;
        fileUploadBtn.disabled = false;
        fileUploadBtn.innerText = "Send Message";
        fileUploadBtn.classList.remove("cursor-not-allowed");
        fileClearBtn.disabled = false;
        fileClearBtn.classList.remove("cursor-not-allowed");
    }
    const formatTextareaInput = (errMsg) => {
        formatTextareaInputLogic(false, errMsg);
        fileUploadBtn.innerText = "Uh Oh!";
        setTimeout(() => {
            resetFileModalBtns();
            formatTextareaInputLogic(true);
            inputMsg.value = lastMsg;
            chatMsgFileTextInput.value = lastMsg;
        }, 2.5 * 1000);
    }
    let fileModalOpenFlag = false;
    const fileModal = document.getElementById("fileModal");
    messageArea.addEventListener("dragenter", () => {
        if (!fileModalOpenFlag) {
            HSOverlay.open(fileModal);
        }
    })
    const fileUploadBtn = document.getElementById("fileUploadBtn");
    FilePond.setOptions({
        server: {
            process: async (fieldName, file, metadata, load, error, progress, abort) => {
                try {
                    if (blocked) {
                        throw new Error("You cannot send any messages to this user.");
                    }
                    const formDataFunction = () => {
                        const formData = new FormData();
                        formData.append("sender", "{{ sender.id }}");
                        formData.append("receiver", "{{ receiver.id }}");
                        return formData;
                    }
                    await uploadChunks(
                        "{{ url_for('upload_chat_file') }}",
                        file,
                        metadata,
                        {{ MAX_CHUNK_SIZE }},
                        formDataFunction,
                        uploadToken,
                        progress,
                    )
                } catch (err) {
                    const errorMsg = err.message || "Something went wrong.";
                    formatTextareaInput(errorMsg);
                    error(errorMsg);
                    return;
                }

                load("File uploaded successfully.");
            },
        },
        labelFileProcessingError: (e) => {
            return e.message || "Something went wrong.";
        },
        onprocessfiles: async () => {
            // all files has been uploaded
            uploadToken = null;
            filePondImgForm.removeFiles();
            resetFileModalBtns();
            chatMsgFileTextInput.value = "";
            inputMsg.value = "";
            HSOverlay.close(fileModal);
        },
        instantUpload: false,
        allowMultiple: true,
        allowRevert: false,
        allowProcess: false,
        maxFiles: 3,
        maxParallelUploads: 3,
        maxFileSize: {{ sender.mirai_plus | lower }} ? "1000MB" : "500MB",
        labelIdle: "Drag & Drop your files or <span class='filepond--label-action'>Browse</span> (Maximum of 3 files at a time!)",
    }); 
    FilePond.parse(document.body);

    // Reset the FilePond input when the modal is closed
    const filePondImgForm = FilePond.find(document.getElementById("filepondInput"));
    const fileClearBtn = document.getElementById("fileClearBtn");
    fileClearBtn.addEventListener("click", () => {
        const uploadedFiles = filePondImgForm.getFiles();
        if (uploadedFiles.length > 0 && !isUploading) {
            filePondImgForm.removeFiles();
        }
    });

    fileUploadBtn.addEventListener("click", async (event) => {
        if (blocked || insufficientPerms) {
            return;
        }

        const filesToUpload = filePondImgForm.getFiles();
        const numOfFiles = filesToUpload.length;
        if (numOfFiles > 0) {
            fileUploadBtn.disabled = true;
            isUploading = true;
            fileUploadBtn.innerText = "Uploading...";
            fileUploadBtn.classList.add("cursor-not-allowed");
            fileClearBtn.disabled = true;
            fileClearBtn.classList.add("cursor-not-allowed");

            const chatFileMsgText = chatMsgFileTextInput.value.trim() || null;
            lastMsg = chatFileMsgText;
            try {
                removeDuplicateFilename(filesToUpload);
                uploadToken = await fetchUploadId(
                    "{{ url_for('get_upload_id') }}", 
                    "{{ sender.id }}", // sender
                    numOfFiles, // number of files
                    chatFileMsgText, // text msg
                    "chat", // purpose
                    {receiver: "{{ receiver.id }}"}, // extra data for upload
                );
            } catch (err) {
                console.error(err);
                formatTextareaInput(err.message || "Something went wrong.");
                return;
            }

            filePondImgForm.processFiles();
        }
    });
    fileModal.addEventListener("close.hs.overlay", () => {
        filePondImgForm.removeFiles();
        resetFileModalBtns();
        fileModalOpenFlag = false;
    });
    fileModal.addEventListener("open.hs.overlay", () => {
        fileModalOpenFlag = true;
        chatMsgFileTextInput.focus();
    });
</script>
<script nonce="{{ csp_nonce }}">
    let ws = null;
    inputMsg.addEventListener("keypress", (event) => {
        // Check if the key pressed is the Enter key (code "Enter")
        if ((event.code === "Enter" || event.code == "NumpadEnter") && !event.shiftKey) {
            // Prevent the default action (newline character insertion)
            event.preventDefault();
            sendMessage(ws, event);
            resetTextareaHeight(inputMsg);
        }
    });

    let authenticatedToChat = false;
    const chatPasswordProtectionForm = document.getElementById("passwordProtectionForm");
    chatPasswordProtectionForm.addEventListener("submit", (event) => {
        event.preventDefault();
        grecaptcha.enterprise.execute(chatPasswordWidgetId);
    });
    let chatPasswordModalOpened = false;
    const chatPasswordProtectionInput = chatPasswordProtectionForm.querySelector("[name='chatPasswordInput']");
    const chatPasswordProtectionModal = document.getElementById("chatPasswordModal");
    const chatPasswordError = document.getElementById("chatPasswordError");
    const chatPasswordErrorMsg = document.getElementById("chatPasswordErrorMsg");
    const chatPasswordSuccess = document.getElementById("chatPasswordSuccess");
    const chatPasswordSuccessMsg = document.getElementById("chatPasswordSuccessMsg");
    const doNotAskAgain = chatPasswordProtectionForm.querySelector("[name='doNotAskAgain']");
    function passwordCallback(token) {
        if (!chatPasswordProtectionForm.checkValidity()) {
            chatPasswordProtectionForm.reportValidity();
            grecaptcha.enterprise.reset(chatPasswordWidgetId);
            return;
        }

        const chatPasswordInput = chatPasswordProtectionInput.value;
        const data = {
            password: chatPasswordInput,
            recaptcha_token: token,
            do_not_ask_again: doNotAskAgain.checked,
        };
        ws.send(JSON.stringify(data));
        grecaptcha.enterprise.reset(chatPasswordWidgetId);
    };
    async function forgotChatPassCallback(token) {
        const data = {
            recaptcha_token: token,
        };
        let response;
        try {
            response = await fetch("{{ url_for('forgot_chat_password') }}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "{{ CSRF_HEADER_NAME }}": getCSRFToken(),
                },
                body: JSON.stringify(data),
            });
            if (!response.ok) {
                throw new Error("Something went wrong when requesting to reset chat password.");
            } else {
                chatPasswordError.classList.add("hidden");
                chatPasswordSuccess.classList.remove("hidden");
                chatPasswordSuccess.innerText = "Please check your email for a link to reset your chat password.";
            }
        } catch (err) {
            console.error(err);
            chatPasswordSuccess.classList.add("hidden");
            chatPasswordError.classList.remove("hidden");
            chatPasswordErrorMsg.innerText = "Something went wrong when requesting to reset chat password.";
        }
        grecaptcha.enterprise.reset(forgotChatPasswordWidgetId);
    }

    const loadingSpinner = document.getElementById("loadingSpinner");
    let latestRetrievedMsg = new Date(0);
    const messageIds = new Set();
    let isProcessingMessage = false; // a mutex to prevent race conditions
    let oldestMsgId = null;
    let hasFetchedNewMsgs = false;
    let fetchingMutex = false; // a mutex to prevent race conditions when fetching old messages
    let noMoreOldMsgs = false; // a flag to prevent unnecessary requests to the server
    const loadingOldMsgAlert = document.getElementById("loadingOldMsgAlert");

    let retrieveInitialMessages = true;
    const scrollFn = () => {
        if (!retrieveInitialMessages && !noMoreOldMsgs && !fetchingMutex && mainMsgDiv.scrollTop === 0 && !isProcessingMessage && ws.readyState === 1) {
            hasFetchedNewMsgs = true;
            fetchingMutex = true;
            loadingOldMsgAlert.classList.remove("hidden");

            // The user has scrolled to the top of the chat window
            // Send a request to the server to retrieve more messages
            ws.send(JSON.stringify({
                "fetch_messages": true,
                "oldest_msg_id": oldestMsgId,
            }));
        }
    };
    mainMsgDiv.addEventListener("scroll", scrollFn);
    let fetchOnAuthenticate = false;
    let hasAlreadyFetchedOnLoad = false;
    const fetchMsgOnLoad = async () => {
        if (!hasAlreadyFetchedOnLoad) {
            hasAlreadyFetchedOnLoad = true;
            await new Promise((resolve) => setTimeout(resolve, 3000));
            while (authenticatedToChat && mainMsgDiv.scrollTop === 0 && !noMoreOldMsgs) {
                scrollFn();
                await new Promise((resolve) => setTimeout(resolve, 1500));
            }
        }
    }

    const inputMsgPlaceholder = "Message @{{ receiver.username }}";
    for (const textArea of textAreas) {
        textArea.placeholder = inputMsgPlaceholder;
    }

    // Get the current scroll position and the scrollable content height
    let scrollPos = mainMsgDiv.scrollTop;
    let scrollHeight = mainMsgDiv.scrollHeight;
    function startWebSocket() {
        {% with ws_url = url_for("chat_ws", external=True, receiver_uid=receiver.id) | replace("https://", "wss://", 1) %}
            ws = new WebSocket("{{ ws_url }}");
        {% endwith %}

        ws.onopen = () => {
            console.log("%c Connection established.", "color: white; background: green;");
            ws.send(JSON.stringify({
                "fetch_initial_messages": retrieveInitialMessages,
            }));
            retrieveInitialMessages = false;
        };

        ws.onclose = (event) => {
            fetchingMutex = false;
            HSOverlay.close(fileModal);
            console.log("%c Connection closed, trying to reconnect in 3 seconds...", "color: white; background: red;");
            if (event.reason) {
                console.log(`%c Reason(s): ${event.reason}`, "color: white; background: red;");
                if (event.reason == "Not authenticated.") {
                    window.location.href = "{{ url_for('login') }}";
                } else if (event.reason.includes("lonely") || event.reason == "No such user exists.") {
                    window.location.href = "{{ url_for('chat') }}";
                }
            }
            if (loadingSpinner.classList.contains("hidden")) {
                loadingSpinner.classList.remove("hidden");
            }

            let count = 3;
            console.log(`%c Reconnecting in ${count}...`, "color: white; background: red;");
            const countdown = setInterval(() => {
                count--;
                console.log(`%c Reconnecting in ${count}...`, "color: white; background: red;");
                if (count === 0) {
                    clearInterval(countdown);
                    startWebSocket();
                }
            }, 1000);
        };

        ws.onmessage = async (event) => {
            while (isProcessingMessage) {
                await new Promise((resolve) => setTimeout(resolve, 100));
            }
            isProcessingMessage = true;

            const response = JSON.parse(event.data);
            try {
                if (response.require_password) {
                    console.log("Password required.");
                    if (!chatPasswordModalOpened) {
                        chatPasswordModalOpened = true;
                        HSOverlay.open(chatPasswordProtectionModal);
                    }
                    return;
                }
                switch (response.password_result) {
                    case "Correct password.":
                        console.log("Password correct.");
                        chatPasswordSuccess.classList.remove("hidden");
                        chatPasswordSuccess.innerText = "Successfully authenticated to chat.";
                        chatPasswordError.classList.add("hidden");
                        setTimeout(() => {
                            HSOverlay.close(chatPasswordProtectionModal);
                            chatPasswordSuccess.classList.add("hidden");
                        }, 1000);
                        chatPasswordModalOpened = false;
                        authenticatedToChat = true;
                        fetchOnAuthenticate = true;
                        return;
                    case "Invalid password.":
                        console.log("Password incorrect.");
                        chatPasswordSuccess.classList.add("hidden");
                        chatPasswordError.classList.remove("hidden");
                        chatPasswordErrorMsg.innerText = "Incorrect chat password.";
                        return;
                    case "Invalid reCAPTCHA token.":
                        console.log("Failed to verify that the user is not a bot.");
                        chatPasswordSuccess.classList.add("hidden");
                        chatPasswordError.classList.remove("hidden");
                        chatPasswordErrorMsg.innerText = "Failed to verify that the user is not a bot. Please try submitting the form again.";
                        return;
                    case undefined: // no password required
                        authenticatedToChat = true;
                        fetchOnAuthenticate = true;
                        break;
                    default:
                        // usually this is because of a internal server error
                        console.log("Something went wrong.");
                        chatPasswordSuccess.classList.add("hidden");
                        chatPasswordError.classList.remove("hidden");
                        chatPasswordErrorMsg.innerText = "Something went wrong. Please try again later.";
                        return;
                }

                // remove the loading spinner
                if (!loadingSpinner.classList.contains("hidden")) {
                    loadingSpinner.classList.add("hidden");
                }

                if (response.chats) {
                    processChats(response.chats, "{{ receiver.id }}");
                    return;
                }

                if (response.deleted || response.expired) {
                    const messageId = response.message_id;
                    const messageDiv = document.getElementById(messageId);
                    if (messageDiv) {
                        const action = response.deleted ? "been deleted" : "disappeared due to {{ receiver.username }}'s or your privacy settings.";
                        const messageDivMainContent = messageDiv.querySelector(".chat-content");
                        messageDivMainContent.innerHTML = `
                            <span class="font-bold underline italic">This message has ${action}</span>
                        `;
                        const msgDeleteBtn = messageDivMainContent.querySelector("button");
                        if (msgDeleteBtn) {
                            msgDeleteBtn.remove();
                        }
                    }
                    return;
                }

                if (response.blocked) {
                    blocked = true;
                    const blockedBy = response.blocked_by === "receiver" ? 
                                        "{{ receiver.username }} blocked you" : "you blocked {{ receiver.username }}";
                    formatTextareaInputLogic(false, `You cannot send messages because ${blockedBy}.`);
                    // errMsgFormat(`You cannot send messages because ${blockedBy}.`);
                    return;
                } else if (response.insufficient_permissions) {
                    insufficientPerms = true;
                    const blockedFor = {
                        "receiver": {
                            "followers": "you are not following {{ receiver.username }}",
                            "disabled": "{{ receiver.username }} has disabled their chat",
                        }, "sender": {
                            "followers": "{{ receiver.username }} is not your follower",
                            "disabled": "you have disabled your chat",
                        }
                    }[response.restricted_by][response.permission_level]
                    formatTextareaInputLogic(false, `You cannot send messages because ${blockedFor}.`);
                    // formatTextareaInputLogic(false, "You cannot send messages because you do not have sufficient permissions.");
                    // errMsgFormat("You cannot send messages because you do not have sufficient permissions.");
                    return;
                } else if ((blocked || insufficientPerms) && response.permissions_checked) {
                    // user has been unblocked
                    formatTextareaInputLogic(true);
                    blocked = false;
                    insufficientPerms = false;
                } else if (response.error) {
                    const errMsg = response.error;
                    console.error("Error: " + errMsg);
                    formatTextareaInput(errMsg);
                    return;
                };

                if (response.new_chat_session) {
                    loadingOldMsgAlert.classList.add("hidden");
                    noMoreOldMsgs = true;
                    fetchingMutex = false;
                    return; // no more messages to fetch
                }

                const messageId = response._id;
                const fetching = response.fetching;
                const fetchCompleted = response.fetch_completed;
                if (fetchingMutex) {
                    if (!fetching && !fetchCompleted) {
                        // usually shouldn't happen but just in case if there's a race condition
                        console.log("dropped message:", messageId, "due to fetching process...")
                        return;
                    }
                }
                if (fetchCompleted) {
                    fetchingMutex = false;
                    loadingOldMsgAlert.classList.add("hidden");
                    if (response.no_messages) {
                        noMoreOldMsgs = true;
                        return; // no more messages to fetch
                    }
                }

                if (messageId == null) {
                    return;
                }
                if (oldestMsgId === null || messageId < oldestMsgId) {
                    oldestMsgId = messageId;
                }

                // if the message is already in the chat window, don't add it again
                // this is to prevent duplicate messages caused by race conditions
                // when the user scrolls to the top of the chat window to retrieve more messages
                hasMsgElement = document.getElementById(messageId);
                if (hasMsgElement) {
                    return;
                }

                const responseTimestamp = parseInt(response.timestamp * 1000);
                const dateObj = new Date(responseTimestamp);

                const sender = response.sender;
                const receiver = response.receiver;
                const messageType = response.type;
                const isSender = (sender == "{{ sender.id }}");
                const deleteFormBtn = `delete#${messageId}`;
                const msgDropdownId = `msgDropdown#${messageId}`;
                const imageViewId = `imageView#${messageId}`;

                let msgBodyContent = "";
                if (response.message) {
                    const formattedText = wrapUrlsInAnchorTags(DOMPurify.sanitize(response.message));
                    msgBodyContent = `<div class="break-all">${formattedText}</div>`;
                }

                let msgBodyHtml = "";
                let hasEmbeds = false;
                const embedsResult = getEmbedsForChatMsg(
                    messageId,
                    response.message, 
                    response.files, 
                    isSender,
                );
                const additionalMsgHtml = embedsResult[0]; 
                const fileEmbedsResults = embedsResult[1];
                const twitterPostEmbedsIds = embedsResult[2];
                hasEmbeds = (additionalMsgHtml != "");
                const embedsHtml = !hasEmbeds ? additionalMsgHtml :
                    '<div class="lg:w-[400px] w-[300px]">' + additionalMsgHtml + "</div>"; 

                if (!isSender) {
                    msgBodyHtml = `
                        <div class="chat chat-start" id="${messageId}">
                            <div class="chat-image avatar">
                                <div class="w-10 rounded-full">
                                    <img src="{{ receiver.profile_image }}" referrerpolicy="no-referrer">
                                </div>
                            </div>
                            <div class="chat-header message-receiver">
                                {{ receiver.display_name }}
                            </div>
                            <div class="chat-bubble px-6 py-3 max-w-xs lg:max-w-md
                                ${response.expiry ?'bg-gray-400': 'bg-gray-200'} text-gray-700 text-sm 
                                ${hasEmbeds ? '' : 'flex'} items-center flex-row-reverse chat-content">

                                <!-- msg content -->
                                <span class='flex mb-1 whitespace-pre-wrap'>${msgBodyContent}</span>

                                <!-- embeds -->
                                ${embedsHtml}
                            </div>
                            <div class="chat-footer opacity-50">
                                <time data-chat-timestamp="${responseTimestamp}">
                                    ${formatTimestamp(dateObj)}
                                </time>
                            </div>
                        </div>
                    `;
                } else {
                    msgBodyHtml = `
                        <div class="chat chat-end" id="${messageId}">
                            <div class="chat-image avatar">
                                <div class="w-10 rounded-full">
                                    <img src="{{ sender.profile_image }}" referrerpolicy="no-referrer">
                                </div>
                            </div>
                            <div class="chat-header">
                                You
                            </div>
                            <div class="flex items-center flex-row-reverse group">
                                <div class="px-6 py-3 max-w-xs lg:max-w-md chat-bubble 
                                    ${response.expiry ? 'bg-main-900': 'bg-main-100'} 
                                    text-gray-100 text-sm chat-content">

                                    <!-- msg dropdown -->
                                    <div class="hs-dropdown relative inline-flex [--placement:bottom-right]">
                                        <button id="${msgDropdownId}" type="button" class="hidden group-hover:flex hs-dropdown-toggle inline-flex justify-center items-center gap-2 font-medium align-middle transition-all text-base">
                                            <svg class="h-6 w-6" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </button>
                                        <div class="whitespace-nowrap hs-dropdown-menu w-72 transition-[opacity,margin] duration hs-dropdown-open:opacity-100 opacity-0 hidden z-10 bg-white shadow-md rounded-lg p-2" aria-labelledby="${msgDropdownId}">
                                            <button id="${deleteFormBtn}" data-message-id="${messageId}" class="flex items-center gap-x-3.5 py-2 px-3 rounded-md text-sm text-red-500 hover:text-red-800 w-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" class="w-full h-full fill-current" viewBox="0 0 16 16">
                                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                                </svg>
                                                Delete Message
                                            </button>
                                        </div>
                                    </div>

                                    <!-- msg content -->
                                    <span class='flex mb-1 whitespace-pre-wrap'>${msgBodyContent}</span>

                                    <!-- embeds -->
                                    ${embedsHtml}
                                </div>
                            </div>
                            <div class="chat-footer opacity-50">
                                <time data-chat-timestamp="${responseTimestamp}">
                                    ${formatTimestamp(dateObj)}
                                </time>
                            </div>
                        </div>
                    `;
                }

                const newDiv = document.createElement("div");
                newDiv.innerHTML = msgBodyHtml;
                // prepend the new message to the message area
                if (response.prepend) {
                    // to keep track of the user's scroll position
                    scrollPos = mainMsgDiv.scrollTop;
                    scrollHeight = mainMsgDiv.scrollHeight;

                    // using messageIds set to keep track of the order of the messages.
                    // This to ensure that the messages are prepended in the correct order.
                    let firstSmallerId = null;
                    for (const id of messageIds) {
                        if (id < messageId) {
                            firstSmallerId = id;
                            break;
                        }
                    }
                    if (firstSmallerId) {
                        // appendChild the message to the 
                        // first message with a smaller id than the new message
                        const firstSmallerIdMsg = document.getElementById(firstSmallerId);
                        messageArea.insertBefore(newDiv, firstSmallerIdMsg.parentNode);

                        // remove the smaller id from the set since there's no need to keep track of it anymore
                        messageIds.delete(firstSmallerId); 
                    } else {
                        // prepend the message to the messageArea element if
                        // there are no messages with a smaller id
                        messageArea.prepend(newDiv);
                    }

                    if (!hasFetchedNewMsgs && isSender) {
                        // scroll to the very bottom if the current user had sent a new message
                        mainMsgDiv.scrollTop = mainMsgDiv.scrollHeight;
                    } else {
                        // scroll to the same position to avoid the user from being scrolled to the very top
                        mainMsgDiv.scrollTop = scrollPos + (mainMsgDiv.scrollHeight - scrollHeight);
                    }
                } else {
                    messageArea.appendChild(newDiv);
                    if (isSender) {
                        // scroll to the very bottom if the current user had sent a new message
                        mainMsgDiv.scrollTop = mainMsgDiv.scrollHeight;
                    }
                }
                messageIds.add(messageId);

                // add event listeners to any twitter posts, image, videos, or audio embeds
                for (const twitterObj of twitterPostEmbedsIds) {
                    twttr.widgets.createTweet(
                        twitterObj.id, 
                        document.getElementById(twitterObj.embedId),
                        {
                            dnt: true,
                            theme: "light",
                            align: "center",
                            conversation: "none",
                        }
                    );
                }
                addImgEvent(fileEmbedsResults.img);
                formatPlyrJs(fileEmbedsResults.plyrJs, true);

                // add event listeners to the delete buttons
                if (isSender) {
                    const deleteMsgBtn = document.getElementById(deleteFormBtn);
                    deleteMsgBtn.addEventListener("click", () => {
                        showDeleteMsgModal(ws, messageId);
                    });
                }
            } finally {
                isProcessingMessage = false;
            }
            if (!hasAlreadyFetchedOnLoad && fetchOnAuthenticate) {
                fetchMsgOnLoad();
            }
        };
    };
    startWebSocket();
</script>
{% endblock %}